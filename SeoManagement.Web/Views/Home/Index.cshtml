@model SeoManagement.Web.Models.ViewModels.PagedResultViewModel<SeoManagement.Web.Areas.Admin.Models.ViewModels.NewViewModel>

@{
    ViewData["Title"] = "Trang chủ";
    var configs = ViewBag.Configs as Dictionary<string, string>;
    var recentPerformances = ViewBag.RecentPerformances;
}

@if (recentPerformances != null)
{
    <div class="row mt-2 mb-3">
        <div class="col-12">
            <h4 class="page-title font-bold mb-3">THỐNG KÊ HIỆU SUẤT SEO</h4>
            <div class="card shadow p-4">
                <div class="row mb-4">
                    <div class="col-12">
                        <canvas id="performanceLineChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        @foreach (var perf in recentPerformances)
                        {
                            <div class="mb-3">
                                <h6 class="mb-1">Dự án @perf.ProjectId (@perf.ProjectType)</h6>
                                @switch (perf.ProjectType)
                                {
                                    case "KeywordRankChecker":
                                        <div class="progress">
                                            <div class="progress-bar bg-primary" role="progressbar" style="width: @(perf.AverageKeywordRank * 10)%;" aria-valuenow="@(perf.AverageKeywordRank * 10)" aria-valuemin="0" aria-valuemax="1000">
                                                Thứ hạng TB: @(perf.AverageKeywordRank.ToString("F2"))
                                            </div>
                                        </div>
                                        break;
                                    case "SEOOnPage":
                                        <div class="progress">
                                            <div class="progress-bar bg-success" role="progressbar" style="width: @perf.AverageOnPageScore%;" aria-valuenow="@perf.AverageOnPageScore" aria-valuemin="0" aria-valuemax="100">
                                                Điểm On-Page TB: @perf.AverageOnPageScore%
                                            </div>
                                        </div>
                                        <div class="progress mt-2">
                                            <div class="progress-bar bg-info" role="progressbar" style="width: @perf.PageSpeedScore%;" aria-valuenow="@perf.PageSpeedScore" aria-valuemin="0" aria-valuemax="100">
                                                Tốc độ Trang: @perf.PageSpeedScore%
                                            </div>
                                        </div>
                                        break;
                                    case "PageSpeedChecker":
                                        <div class="progress">
                                            <div class="progress-bar bg-info" role="progressbar" style="width: @perf.PageSpeedScore%;" aria-valuenow="@perf.PageSpeedScore" aria-valuemin="0" aria-valuemax="100">
                                                Tốc độ Trang: @perf.PageSpeedScore%
                                            </div>
                                        </div>
                                        break;
                                    case "BacklinkChecker":
                                        <div class="progress">
                                            <div class="progress-bar bg-warning" role="progressbar" style="width: @(Math.Min(perf.BacklinkCount, 100))%;" aria-valuenow="@(Math.Min(perf.BacklinkCount, 100))" aria-valuemin="0" aria-valuemax="100">
                                                Số Backlink: @perf.BacklinkCount
                                            </div>
                                        </div>
                                        break;
                                    case "IndexChecker":
                                        <div class="progress">
                                            <div class="progress-bar bg-success" role="progressbar" style="width: @((perf.IndexedPageCount ?? 0) * 100 / (perf.IndexedPageCount ?? 0 + perf.UnindexedPageCount ?? 0))%;" aria-valuenow="@(perf.IndexedPageCount ?? 0)" aria-valuemin="0" aria-valuemax="100">
                                                Đã Index: @(perf.IndexedPageCount ?? 0)
                                            </div>
                                        </div>
                                        <div class="progress mt-2">
                                            <div class="progress-bar bg-danger" role="progressbar" style="width: @((perf.UnindexedPageCount ?? 0) * 100 / (perf.IndexedPageCount ?? 0 + perf.UnindexedPageCount ?? 0))%;" aria-valuenow="@(perf.UnindexedPageCount ?? 0)" aria-valuemin="0" aria-valuemax="100">
                                                Chưa Index: @(perf.UnindexedPageCount ?? 0)
                                            </div>
                                        </div>
                                        break;
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}


<div class="row">
    <div class="col-12">
        <div class="mb-3">
            <h3 class="page-title font-bold">Danh sách công cụ</h3>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-4 stretch-card grid-margin">
        <div class="card card-img-holder text-center">
            <div class="card-body">
                <i class="mdi mdi-chart-line card-img-absolute fs-30 text-primary"></i>
                <h4 class="card-title mt-3">Theo dõi hiệu suất SEO</h4>
                <p class="card-text text-muted">Xem hiệu suất</p>
                <a asp-controller="SEOPerformances" asp-action="SelectProject" class="btn btn-primary btn-sm mt-2">Chi tiết</a>
            </div>
        </div>
    </div>

    <!-- Card 1: Outline -->
    <div class="col-md-4 stretch-card grid-margin">
        <div class="card card-img-holder text-center">
            <div class="card-body">
                <i class="mdi mdi-text-box-multiple-outline card-img-absolute fs-30 text-primary"></i>
                <h4 class="card-title mt-3">Outline</h4>
                <p class="card-text text-muted">Công cụ tạo dàn ý bài viết dựa trên từ khóa chính.</p>
                <a asp-controller="Tools" asp-action="Outline" class="btn btn-primary btn-sm mt-2">Chi tiết</a>
            </div>
        </div>
    </div>

    <!-- Card 2: Schema Generator -->
    <div class="col-md-4 stretch-card grid-margin">
        <div class="card card-img-holder text-center">
            <div class="card-body">
                <i class="mdi mdi-folder-key-outline card-img-absolute fs-30 text-primary"></i>
                <h4 class="card-title mt-3">Keyword Rank</h4>
                <p class="card-text text-muted">Công cụ kiểm tra thứ hạng từ khóa</p>
                <a asp-controller="SEOProjects" asp-action="Index" asp-route-projectType="KeywordRankChecker" class="btn btn-primary btn-sm mt-2">Chi tiết</a>
            </div>
        </div>
    </div>

    <!-- Card 4: Keyword Grouping -->
    <div class="col-md-4 stretch-card grid-margin">
        <div class="card card-img-holder text-center">
            <div class="card-body">
                <i class="mdi mdi-nfc-search-variant card-img-absolute fs-30 text-primary"></i>
                <h4 class="card-title mt-3">Keyword Grouping</h4>
                <p class="card-text text-muted">Công cụ gom nhóm các từ khóa có cùng ý định tìm kiếm.</p>
                <a asp-controller="Tools" asp-action="KeywordGrouping" class="btn btn-primary btn-sm mt-2">Chi tiết</a>
            </div>
        </div>
    </div>

    <!-- Card 5: Cannibalization -->
    <div class="col-md-4 stretch-card grid-margin">
        <div class="card card-img-holder text-center">
            <div class="card-body">
                <i class="mdi mdi-link-variant card-img-absolute fs-30 text-primary"></i>
                <h4 class="card-title mt-3">Index Checker</h4>
                <p class="card-text text-muted">Công cụ kiểm tra index cho các URl</p>
                <a asp-controller="Tools" asp-action="Index" class="btn btn-primary btn-sm mt-2">Chi tiết</a>
            </div>
        </div>
    </div>

    <!-- Card 6 -->
    <div class="col-md-4 stretch-card grid-margin">
        <div class="card card-img-holder text-center">
            <div class="card-body">
                <i class="mdi mdi-link-variant card-img-absolute fs-30 text-primary"></i>
                <h4 class="card-title mt-3">On Page Check</h4>
                <p class="card-text text-muted">Công cụ kiểm tra seo on-page</p>
                <a asp-controller="SEOProjects" asp-action="Index" asp-route-projectType="SEOOnPage" class="btn btn-primary btn-sm mt-2">Chi tiết</a>
            </div>
        </div>
    </div>
</div>


<div class="row mt-3">
    <div class="col-12">
        <div class="mb-3">
            <h3 class="page-title">Tin tức</h3>
        </div>
    </div>
</div>

<div class="row">
    @if (!Model.Items.Any())
    {
        <div class="col-12">
            <p class="text-muted">Hiện tại chưa có tin tức nào.</p>
        </div>
    }
    else
    {
        @foreach (var item in Model.Items)
        {
            <div class="col-md-4 stretch-card grid-margin">
                <div class="card shadow-sm border-0">
                    <div class="card-body">
                        <h4 class="card-title">@item.Title</h4>
                        <p class="card-description text-muted">
                            @(item.Content.Length > 100 ? item.Content.Substring(0, 100) + "..." : item.Content)
                        </p>
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <small class="text-muted">Ngày đăng: @item.CreatedDate.ToString("dd/MM/yyyy")</small>
                            <a href="@Url.Action("Details", "News", new { area = "", newId = item.NewsID })" class="btn btn-outline-primary btn-sm">
                                Đọc thêm
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        }
    }
</div>

<!-- Phần Các kênh cần hỗ trợ -->
<div class="row mt-3">
    <div class="col-12">
        <div class="mb-3">
            <h3 class="page-title">Các kênh cần hỗ trợ</h3>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12 grid-margin">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <!-- Email -->
                    <div class="col-md-4 text-center">
                        <i class="mdi mdi-email fs-30 text-primary"></i>
                        <h5 class="mt-2">Email</h5>
                        @if (configs.ContainsKey("SettingEmail"))
                        {
                            <p class="text-muted"><i class="bi bi-envelope me-2"></i>@configs["SettingEmail"]</p>
                        }
                    </div>
                    <!-- Điện thoại -->
                    <div class="col-md-4 text-center">
                        <i class="mdi mdi-phone fs-30 text-primary"></i>
                        <h5 class="mt-2">Điện thoại</h5>
                        @if (configs.ContainsKey("SettingHotline"))
                        {
                            <p class="text-muted"><i class="bi bi-envelope me-2"></i>@configs["SettingHotline"]</p>
                        }
                    </div>
                    <!-- Facebook -->
                    <div class="col-md-4 text-center">
                        <i class="mdi mdi-facebook fs-30 text-primary"></i>
                        <h5 class="mt-2">Facebook</h5>
                        @if (configs.ContainsKey("SettingFacebook"))
                        {
                            <p class="text-muted"><i class="bi bi-envelope me-2"></i><a href="@configs["SettingFacebook"]" target="_blank" class="text-primary">fb.com/seomanagement</a></p>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Thêm Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const performanceData = @Html.Raw(Json.Serialize(ViewBag.RecentPerformances));
            performanceData.forEach(perf => {
        const date = new Date(perf.RecordedAt);
        console.log(`RecordedAt: ${perf.RecordedAt}, Date: ${date}, Valid: ${!isNaN(date)}`);
    });
        console.log("Performance Data:", performanceData); // Debug dữ liệu

        // Sắp xếp dữ liệu theo RecordedAt
        performanceData.sort((a, b) => {
            const dateA = new Date(a.RecordedAt);
            const dateB = new Date(b.RecordedAt);
            return dateA - dateB;
        });

        // Chuẩn bị nhãn (trục X) từ RecordedAt
       const labels = performanceData.map(perf => {
          const date = new Date(perf.recordedAt);
            return isNaN(date) ? "Invalid Date" : date.toLocaleString();
        });

        // Chuẩn bị dữ liệu cho các chỉ số
         const datasets = [
        {
            label: 'Thứ hạng từ khóa TB',
            data: performanceData.map(perf => perf.averageKeywordRank || 0),
            borderColor: '#FF6384',
            fill: false,
            tension: 0.1
        },
        {
            label: 'Điểm On-Page TB (%)',
            data: performanceData.map(perf => perf.averageOnPageScore || 0),
            borderColor: '#36A2EB',
            fill: false,
            tension: 0.1
        },
        {
            label: 'Tốc độ trang (%)',
            data: performanceData.map(perf => perf.pageSpeedScore || 0),
            borderColor: '#FFCE56',
            fill: false,
            tension: 0.1
        },
        {
            label: 'Số Backlink',
            data: performanceData.map(perf => perf.backlinkCount || 0),
            borderColor: '#4BC0C0',
            fill: false,
            tension: 0.1
        },
        {
            label: 'Số trang Index',
            data: performanceData.map(perf => perf.indexedPageCount || 0),
            borderColor: '#9966FF',
            fill: false,
            tension: 0.1
        },
        {
            label: 'Số trang Chưa Index',
            data: performanceData.map(perf => perf.unindexedPageCount || 0),
            borderColor: '#FF4500', // Màu cam đậm cho trang chưa index
            fill: false,
            tension: 0.1
        }
    ];

        const ctx = document.getElementById('performanceLineChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Xu hướng hiệu suất theo thời gian'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                               const label = context.dataset.label || '';
                                const value = context.parsed.y !== undefined ? context.parsed.y : 0;
                                const project = performanceData[context.dataIndex] || {};
                                const projectId = project.projectId !== undefined ? project.projectId : 'N/A';
                                const projectType = project.projectType || 'N/A';
                                return `${label}: ${value} (Dự án: ${projectId} - ${projectType})`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Thời gian'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Chỉ số'
                        },
                        beginAtZero: true
                    }
                }
            }
        });
    });
</script>

<style>
    .card-img-holder {
        position: relative;
        background-color: #ffffff;
        border: none;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
    }

        .card-img-holder:hover {
            transform: scale(1.05);
        }

    .card-img-absolute {
        position: absolute;
        top: 15px;
        right: 15px;
        opacity: 0.2;
        font-size: 40px !important;
    }

    .card-title {
        font-size: 1.25rem;
        font-weight: 500;
        color: #333;
    }

    .card-text {
        font-size: 0.9rem;
        color: #6c757d;
        margin-bottom: 15px;
    }

    .progress {
        height: 20px;
        margin-bottom: 10px;
    }

    .progress-bar {
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>